{% extends 'base.html' %}

{% block content %}

<div class="container-fluid mt-4">
    <!-- Page Header -->
    <h1 class="text-white">Portfolio Characteristics</h1>
    <hr class="my-2 text-white">
    <p class="lead text-white">The following tabs provide various tools to dive into the portfolio details.</p>

    <!-- Row 1: Summary Cards (Portfolio Value | PnL | Last Updated) -->
    {% include 'partials/portfolio/row1_summary_cards.html' %}

    <!-- Row 2: Analysis Charts -->
    {% include 'partials/portfolio/row2_analysis_charts.html' %}

    <!-- Row 3: Performance Chart -->
    {% include 'partials/portfolio/row3_performance_chart.html' %}

    <!-- Row 4: Detailed Tabs -->
    {% include 'partials/portfolio/row4_tabs.html' %}
</div>

{% endblock %}

{% block extra_js %}
<!-- Load Plotly.js library for rendering interactive charts -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<script>
    // Portfolio Allocation Pie Chart
    var allocationData = {{ allocation_chart|safe }};
    Plotly.newPlot('allocation-chart', allocationData.data, allocationData.layout, {responsive: true});

    // Portfolio Performance Time Series Chart
    var performanceData = {{ performance_chart|safe }};
    Plotly.newPlot('performance-chart', performanceData.data, performanceData.layout, {responsive: true});

    // HTMX + Bootstrap Modal Fix
    // HTMX doesn't auto-close Bootstrap modals after form submission.
    // Listen for afterSwap event, close modal, and clean up backdrop/body styles.
    document.body.addEventListener('htmx:afterSwap', function(event) {
        // Only proceed if the swapped element is our orders table
        if (event.detail.target.id === 'orders-table') {
            var modalElement = document.getElementById('addOrderModal');
            if (modalElement) {
                // Get existing Bootstrap modal instance or create new one
                // (getInstance returns null if modal was opened before HTMX swap)
                var modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                
                // Close the modal using Bootstrap's API
                modal.hide();
                
                // Clean up Bootstrap's side effects after modal close animation (300ms)
                setTimeout(function() {
                    // Remove the dark backdrop that Bootstrap creates
                    var backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    
                    // Remove 'modal-open' class that Bootstrap adds to body
                    document.body.classList.remove('modal-open');
                    
                    // Reset body styles that Bootstrap modifies to prevent scrolling
                    document.body.style.overflow = '';        // Restore scrolling
                    document.body.style.paddingRight = '';    // Remove scrollbar compensation
                }, 300);
            }
        }
    });
</script>
{% endblock %}
