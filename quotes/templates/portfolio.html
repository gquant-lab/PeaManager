{% extends 'base.html' %}

{% block content %}

<div class="container-fluid mt-4" style="padding-left: 13rem; padding-right: 13rem;">
    <!-- Page Header -->
    <h1 class="text-white">Portfolio Characteristics</h1>
    <hr class="my-2 text-white">
    <p class="lead text-white">The following tabs provide various tools to dive into the portfolio details.</p>

    <!-- Row 1: Summary Cards (Portfolio Value | PnL | Last Updated) -->
    {% include 'partials/portfolio/row1_summary_cards.html' %}

    <!-- Row 2: Performance Chart (Full Width) -->
    {% include 'partials/portfolio/row2_analysis_charts.html' %}

    <!-- Row 3: Table (75%) + Geographic Exposure (25%) -->
    <div class="row mt-4">
        <div class="col-md-9">
            <div class="card bg-dark text-white">
                <div class="card-body p-0">
                    {% include 'partials/portfolio/row4_overview_tab.html' %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white h-100">
                <div class="card-header">
                    <h5 class="mb-0">Geographic Exposure</h5>
                </div>
                <div class="card-body" style="padding: 0.5rem;">
                    <div id="geography-chart" style="height: 135px;">
                        <p class="text-muted text-center py-4">France / Europe / USA / World - Coming Soon</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Load Plotly.js library for rendering interactive charts -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<script>
    // Portfolio Allocation Pie Chart
    // var allocationData = {{ allocation_chart|safe }};
    // Plotly.newPlot('allocation-chart', allocationData.data, allocationData.layout, {responsive: true});

    // Portfolio Performance Time Series Chart
    var performanceData = {{ performance_chart|safe }};
    Plotly.newPlot('performance-chart', performanceData.data, performanceData.layout, {responsive: true});

    // Timeframe button functionality
    document.querySelectorAll('[data-timeframe]').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const timeframe = this.getAttribute('data-timeframe');

            // Handle Custom button specially
            if (timeframe === 'custom') {
                const modal = new bootstrap.Modal(document.getElementById('customDateModal'));
                modal.show();
                return;  // Don't fetch data yet
            }

                // Handle Year button
            if (timeframe === 'year') {
                const modal = new bootstrap.Modal(document.getElementById('yearModal'));
                modal.show();
                return;
            }

            const pk = this.closest('.btn-group').getAttribute('data-portfolio-id');
            
            fetch(`/portfolio/${pk}/chart/?timeframe=${timeframe}`)
                .then(response => response.json())
                .then(data => {
                    Plotly.react('performance-chart', data.data, data.layout);
                });
        });
    });

    // Custom date range Apply button
    document.getElementById('apply-custom-dates').addEventListener('click', function() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }
        
        const pk = document.querySelector('[data-portfolio-id]').getAttribute('data-portfolio-id');
        
        fetch(`/portfolio/${pk}/chart/?start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                Plotly.react('performance-chart', data.data, data.layout);
                bootstrap.Modal.getInstance(document.getElementById('customDateModal')).hide();
            });
    });

    // Year Apply button
    document.getElementById('apply-year').addEventListener('click', function() {
        const year = document.getElementById('year-input').value;
        
        if (!year) {
            alert('Please enter a year');
            return;
        }
        
        const pk = document.querySelector('[data-portfolio-id]').getAttribute('data-portfolio-id');
        
        fetch(`/portfolio/${pk}/chart/?year=${year}`)
            .then(response => response.json())
            .then(data => {
                Plotly.react('performance-chart', data.data, data.layout);
                bootstrap.Modal.getInstance(document.getElementById('yearModal')).hide();
            });
    });

    // HTMX + Bootstrap Modal Fix
    // HTMX doesn't auto-close Bootstrap modals after form submission.
    // Listen for afterSwap event, close modal, and clean up backdrop/body styles.
    document.body.addEventListener('htmx:afterSwap', function(event) {
        // Only proceed if the swapped element is our orders table
        if (event.detail.target.id === 'orders-table') {
            var modalElement = document.getElementById('addOrderModal');
            if (modalElement) {
                // Get existing Bootstrap modal instance or create new one
                // (getInstance returns null if modal was opened before HTMX swap)
                var modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                
                // Close the modal using Bootstrap's API
                modal.hide();
                
                // Clean up Bootstrap's side effects after modal close animation (300ms)
                setTimeout(function() {
                    // Remove the dark backdrop that Bootstrap creates
                    var backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    
                    // Remove 'modal-open' class that Bootstrap adds to body
                    document.body.classList.remove('modal-open');
                    
                    // Reset body styles that Bootstrap modifies to prevent scrolling
                    document.body.style.overflow = '';        // Restore scrolling
                    document.body.style.paddingRight = '';    // Remove scrollbar compensation
                }, 300);
            }
        }
    });
</script>
{% endblock %}
